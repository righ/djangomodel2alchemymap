name: Unit tests
on: [push]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:12
        env:
          POSTGRES_USER: d2a
          POSTGRES_PASSWORD: d2a
          POSTGRES_DB: d2a
        ports:
          - 5432/tcp
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

      mysql:
        image: mysql:5.7
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: d2a
          MYSQL_USER: d2a
          MYSQL_PASSWORD: d2a
        ports:
          - 3306/tcp
        options: --health-cmd "mysqladmin ping -h localhost" --health-interval 20s --health-timeout 10s --health-retries 10

    strategy:
      max-parallel: 4
      matrix:
        python-version: ['3.5.7', '3.8.0']
        django-version: ['1.11.', '2.2.9', '3.0.1']
        alchemy-version: ['0.9.10', '1.3.12']

    steps:
      - uses: actions/checkout@v1
      - name: Set up Python
        uses: actions/setup-python@v1.1.1
        with:
          python-version: ${{ matrix.python-version }}
      - run: sudo apt-get install python3-dev libmysqlclient-dev
      - run: echo "Django==${{ matrix.django-version }}" > django.txt
      - run: echo "SQLAlchemy==${{ matrix.alchemy-version }}" > sqlalchemy.txt
      - run: pip install tox
      - run: tox
